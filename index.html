<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memo Notes App</title>
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }

        /* Authentication Section Styles */
        #authContainer .form-toggle-button {
            background-color: transparent;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        #authContainer .form-toggle-button.active {
            color: #6366f1;
            border-bottom-color: #6366f1;
        }

        /* User Info Section Styles */
        #userInfoContainer {
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        
        .memo-note {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(148, 163, 184, 0.2); 
            border-left-width: 5px; 
            position: relative; 
            min-height: 160px; 
            max-height: 280px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: grab; 
            padding: 1rem; 
        }

        .memo-note.dragging { 
            opacity: 0.5;
        }
        
        .memo-note:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-right-color: rgba(99, 102, 241, 0.3);
            border-top-color: rgba(99, 102, 241, 0.3);
            border-bottom-color: rgba(99, 102, 241, 0.3);
        }

        .memo-note.drag-target-glow {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.7), 0 8px 25px rgba(0, 0, 0, 0.15); /* Indigo glow */
            transform: translateY(-2px); /* Slight lift */
            transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        
        .memo-actions {
            position: absolute;
            top: 8px; 
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .memo-note:hover .memo-actions {
            opacity: 1;
            transform: translateX(0);
        }
        
        .action-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .action-button:hover::before {
            left: 100%;
        }
        
        .primary-button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
        }
        
        .primary-button:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        .edit-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }
        
        .edit-button:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.6);
            transform: translateY(-1px);
        }
        
        .delete-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        
        .delete-button:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
            transform: translateY(-1px);
        }

        .copy-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        .copy-button:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
            transform: translateY(-1px);
        }
        
        .save-edit-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .cancel-button {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .search-results-modal-content { 
            max-width: 600px; 
            width: 90%; 
        }

        .memo-details-modal-content, .edit-memo-modal-content, .large-message-input-modal-content {
            max-width: 800px; /* Increased from 600px */
            width: 90%;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            animation: notificationSlide 0.4s ease forwards;
            z-index: 1001;
            font-weight: 500;
        }

        .floating-notification.hide {
            animation: notificationSlideOut 0.4s ease forwards;
        }
        
        @keyframes notificationSlide {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes notificationSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .counter-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
        }
        
        .scrollbar-custom::-webkit-scrollbar { width: 6px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 3px; }
        .scrollbar-custom::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }
        
        .title-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .importance-level-1 { border-left-color: #22c55e; } /* Green */
        .importance-level-2 { border-left-color: #4ade80; }  
        .importance-level-3 { border-left-color: #84cc16; } 
        .importance-level-4 { border-left-color: #a3e635; }  
        .importance-level-5 { border-left-color: #facc15; } /* Amber */
        .importance-level-6 { border-left-color: #fbbf24; }  
        .importance-level-7 { border-left-color: #f97316; } 
        .importance-level-8 { border-left-color: #ea580c; }  
        .importance-level-9 { border-left-color: #dc2626; } /* Red */
        .importance-level-10 { border-left-color: #b91c1c; }

        .importance-level-complete { border-left-color: #3b82f6; } /* Blue */

        .memo-bg-0 { background-color: #fef9c3; } .memo-bg-1 { background-color: #dbeafe; }
        .memo-bg-2 { background-color: #e0f2fe; } .memo-bg-3 { background-color: #fee2e2; }
        .memo-bg-4 { background-color: #fbcfe8; } .memo-bg-5 { background-color: #ede9fe; }
        .memo-bg-6 { background-color: #d1fae5; } .memo-bg-7 { background-color: #e0f7fa; }
        .memo-bg-8 { background-color: #f3e8ff; } .memo-bg-9 { background-color: #fff7ed; }
        .memo-bg-10 { background-color: #e2e8f0; } .memo-bg-11 { background-color: #ccfbf1; }
        .memo-bg-12 { background-color: #f0fdf4; } .memo-bg-13 { background-color: #ecfdf5; }
        .memo-bg-14 { background-color: #f0f9ff; } .memo-bg-15 { background-color: #fdf2f8; }

        .memo-content-text {
            white-space: pre-wrap; 
            word-break: break-word; 
            overflow-y: hidden; 
            max-height: 120px; 
            line-height: 1.4; 
        }

        .memo-timestamp {
            position: absolute;
            bottom: 6px;
            right: 8px;
            font-size: 0.7rem; 
            color: #6b7280; 
            z-index: 5;
        }
        .search-result-item {
            border-bottom: 1px solid #e5e7eb; 
            padding-bottom: 0.75rem; 
            margin-bottom: 0.75rem; 
            cursor: pointer; 
        }
        .search-result-item:last-child { border-bottom: none; margin-bottom: 0; }
        .search-modal-body { max-height: 70vh; overflow-y: auto; }
        .search-result-content {
            max-height: 100px; 
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent; 
        }
        .search-result-content::-webkit-scrollbar { 
            width: 5px; 
            display: block; 
        }
        .search-result-content::-webkit-scrollbar-thumb { 
            background-color: rgba(156, 163, 175, 0.5); 
            border-radius: 3px;
        }

        .memo-details-content-area {
            max-height: 450px; /* Increased from 300px */
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            padding-right: 8px; 
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
            border-left-width: 5px; 
            padding-left: 1rem; 
            text-align: left; 
        }
        .memo-details-content-area::-webkit-scrollbar {
            width: 6px;
        }
        .memo-details-content-area::-webkit-scrollbar-track {
            background: transparent;
        }
        .memo-details-content-area::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }
        .memo-details-content-area::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        /* New style for large-message-textarea */
        .large-message-textarea {
            max-height: 450px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            padding-right: 8px; 
            /* Changed scrollbar-color for consistency */
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent; /* Matching memo-details-content-area */
            border: 2px solid rgba(148, 163, 184, 0.2); /* Matching editMemoContentInput border */
            padding-left: 1rem; 
            text-align: left; 
            /* Added styles to match input-field */
            background: rgba(255, 255, 255, 0.8); /* input-field background */
            transition: all 0.3s ease; /* input-field transition */
            backdrop-filter: blur(5px); /* input-field backdrop-filter */
            box-shadow: none; /* Remove any previous box-shadow if any */
        }
        .large-message-textarea::-webkit-scrollbar {
            width: 6px;
        }
        .large-message-textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        .large-message-textarea::-webkit-scrollbar-thumb {
            /* Changed scrollbar-thumb color for consistency */
            background: rgba(99, 102, 241, 0.3); /* Matching memo-details-content-area */
            border-radius: 3px;
        }
        .large-message-textarea::-webkit-scrollbar-thumb:hover {
            /* Changed scrollbar-thumb hover color for consistency */
            background: rgba(99, 102, 241, 0.5); /* Matching memo-details-content-area */
        }
        .large-message-textarea:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: #6366f1; /* Match input-field focus border */
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); /* Match input-field focus shadow */
        }


        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s ease-in-out, border-color 0.1s ease-in-out;
        }
        .color-swatch:hover {
            transform: scale(1.05);
        }
        .color-swatch.selected {
            border-color: #6366f1; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
            transform: scale(1.05);
        }

        @keyframes memoHighlight {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .memo-highlight-effect {
            animation: memoHighlight 5s ease-out; 
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .memo-shake-effect {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        #pagesContainer .action-button { cursor: grab; }
        #pagesContainer .action-button.dragging { 
            opacity: 0.5; 
        }
        #pagesContainer .action-button.drag-target-glow {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.7), 0 8px 25px rgba(0, 0, 0, 0.15); 
            transform: translateY(-2px); 
            transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .page-drop-indicator-line {
            width: 0; 
            height: 24px; 
            background-color: transparent; 
            margin: 0; 
            border-radius: 0; 
        }

        .importance-display {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563; 
            background-color: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 12px;
            z-index: 9; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .memo-note:hover .importance-display {
            opacity: 0;
            transform: translateX(-10px);
        }

        .importance-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .light-on-track { background-color: #22c55e; } 
        .light-caution { background-color: #facc15; } 
        .light-urgent { background-color: #dc2626; } 
        .light-complete { background-color: #3b82f6; } 

        .importance-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 500; 
            font-size: 0.875rem; 
            background-color: #e5e7eb; 
            color: #4b5563; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        .importance-button::before { 
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        .importance-button:hover::before {
            left: 100%;
        }
        .importance-button:not(.selected):hover {
            background-color: #d1d5db; 
            transform: none; 
            box-shadow: none; 
        }
        .importance-button.selected {
            color: white; 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .importance-button.selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
        }

        .modal-importance-display {
            display: flex;
            align-items: center;
            gap: 8px; 
            font-size: 1rem; 
            font-weight: 600;
            color: #4b5563;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px; 
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: fit-content; 
        }

        /* New styles for filter buttons */
        .filter-importance-button {
            transition: all 0.2s ease;
            padding: 6px 12px; /* Slightly smaller than save importance buttons */
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.8rem; /* Smaller font size */
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            white-space: nowrap; /* Prevent wrapping */
        }

        .filter-importance-button:hover:not(.selected) {
            background-color: #d1d5db; /* gray-300 */
        }

        .filter-importance-button.selected {
            color: white;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); /* primary button gradient */
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        /* Flatpickr custom theme to match app */
        .flatpickr-calendar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(209, 213, 219, 0.5); /* gray-300 with opacity */
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
            width: auto; /* Adjust width as needed */
        }
        .flatpickr-months .flatpickr-month {
            color: #4b5563; /* gray-600 */
            fill: #4b5563;
        }
        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            color: #6366f1; /* indigo-500 */
            fill: #6366f1;
        }
        .flatpickr-months .flatpickr-prev-month:hover svg,
        .flatpickr-months .flatpickr-next-month:hover svg {
            fill: #4f46e5; /* indigo-600 */
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-size: 1rem;
            font-weight: 600;
            color: #374151; /* gray-700 */
        }
        .flatpickr-current-month input.cur-year {
            font-size: 1rem;
            font-weight: 600;
            color: #374151; /* gray-700 */
        }
        .flatpickr-weekdays {
            background: rgba(243, 244, 246, 0.5); /* gray-100 with opacity */
        }
        span.flatpickr-weekday {
            color: #4b5563; /* gray-600 */
            font-weight: 500;
        }
        .flatpickr-day {
            color: #374151; /* gray-700 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .flatpickr-day:hover,
        .flatpickr-day.prevMonthDay:hover,
        .flatpickr-day.nextMonthDay:hover {
            background: rgba(224, 231, 255, 0.8); /* indigo-100 with opacity */
            color: #4f46e5; /* indigo-600 */
            border-color: transparent;
        }
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange,
        .flatpickr-day.selected.inRange,
        .flatpickr-day.startRange.inRange,
        .flatpickr-day.endRange.inRange,
        .flatpickr-day.selected:focus,
        .flatpickr-day.startRange:focus,
        .flatpickr-day.endRange:focus,
        .flatpickr-day.selected:hover,
        .flatpickr-day.startRange:hover,
        .flatpickr-day.endRange:hover,
        .flatpickr-day.selected.prevMonthDay,
        .flatpickr-day.startRange.prevMonthDay,
        .flatpickr-day.endRange.prevMonthDay,
        .flatpickr-day.selected.nextMonthDay,
        .flatpickr-day.startRange.nextMonthDay,
        .flatpickr-day.endRange.nextMonthDay {
            background: #6366f1; /* indigo-500 */
            border-color: #6366f1;
            color: white;
            box-shadow: none;
        }
        .flatpickr-day.today {
            border-color: #8b5cf6; /* purple-500 */
            color: #7c3aed; /* purple-600 */
        }
        .flatpickr-day.today:hover {
            background: rgba(224, 231, 255, 0.8); /* indigo-100 with opacity */
            color: #4f46e5; /* indigo-600 */
        }
        .flatpickr-day.disabled,
        .flatpickr-day.disabled:hover {
            color: #9ca3af; /* gray-400 */
            background: transparent;
        }
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: #9ca3af; /* gray-400 */
        }

        /* Added for task 2: Disable drag-and-drop when filter active */
        .cursor-not-allowed {
            cursor: not-allowed !important;
        }

        /* Styles for the new large message input modal icon */
        #openLargeMessageInputModal {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            color: #9ca3af; /* gray-400 */
            transition: color 0.2s ease;
        }

        #openLargeMessageInputModal:hover {
            color: #6b7280; /* gray-600 */
        }

        /* Font size controls */
        .font-size-controls {
            position: absolute;
            /* Adjusted from bottom: 8px to give more spacing */
            bottom: 16px; 
            /* Shifted to the left by increasing 'left' from 'right' to ensure spacing from scrollbar */
            right: 24px; 
            display: flex;
            gap: 4px;
            z-index: 20; /* Ensure it's above other elements */
        }

        .font-size-button {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(209, 213, 219, 0.5);
            border-radius: 9999px; /* Full rounded */
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            color: #4b5563;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .font-size-button:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Authentication Container -->
    <div id="authContainer" class="glass-card p-8 rounded-3xl w-full max-w-md">
        <div class="text-center mb-6">
            <h1 class="text-3xl title-gradient mb-2">Memo Notes</h1>
            <p class="text-gray-600">Please log in or register to continue</p>
        </div>

        <div class="border-b border-gray-200 mb-6">
            <div class="flex -mb-px justify-center">
                <button id="showLoginButton" class="form-toggle-button active text-lg font-medium py-3 px-6">Login</button>
                <button id="showRegisterButton" class="form-toggle-button text-lg font-medium py-3 px-6">Register</button>
            </div>
        </div>
        
        <!-- Login Form -->
        <form id="loginForm" class="">
            <div class="space-y-4 mb-6">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="loginEmail" autocomplete="username" class="input-field w-full p-3 rounded-xl focus:outline-none" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" autocomplete="current-password" class="input-field w-full p-3 rounded-xl focus:outline-none" required>
                </div>
            </div>
            <p id="loginError" class="text-sm text-red-500 mb-4 text-center h-5"></p>
            <button type="submit" class="action-button primary-button w-full text-white px-6 py-3 rounded-xl font-semibold text-lg">Log In</button>
        </form>

        <!-- Registration Form -->
        <form id="registerForm" class="hidden">
            <div class="space-y-4 mb-6">
                 <div>
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="registerEmail" autocomplete="email" class="input-field w-full p-3 rounded-xl focus:outline-none" required>
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="registerPassword" autocomplete="new-password" class="input-field w-full p-3 rounded-xl focus:outline-none" required>
                </div>
                 <div>
                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                    <input type="password" id="confirmPassword" autocomplete="new-password" class="input-field w-full p-3 rounded-xl focus:outline-none" required>
                </div>
            </div>
            <p id="registerError" class="text-sm text-red-500 mb-4 text-center h-5"></p>
            <button type="submit" class="action-button primary-button w-full text-white px-6 py-3 rounded-xl font-semibold text-lg">Register</button>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="glass-card p-8 rounded-3xl w-full hidden" style="max-width: 1680px;">
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="space-y-6">
                <!-- Left Column Content (Page Management, Memo Input) -->
                <div class="text-center">
                    <h1 class="text-3xl title-gradient mb-2">Memo Notes</h1>
                    <p class="text-gray-600 text-sm">Organize your daily work messages</p>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md border border-gray-200">
                    <div id="pagesContainer" class="flex flex-wrap gap-2 mb-4 items-center"></div> 
                    <div class="flex gap-2">
                        <input type="text" id="newPageNameInput" class="input-field flex-1 p-2 rounded-xl focus:outline-none text-sm" placeholder="New page name..." maxlength="20"/>
                        <button id="addPageButton" class="action-button primary-button text-white px-4 py-2 rounded-xl font-medium text-sm">➕ Add Page</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md border border-gray-200">
                    <label for="memoNameInput" class="text-gray-700 font-medium block mb-1">Memo Name:</label>
                    <input type="text" id="memoNameInput" class="input-field w-full p-3 rounded-xl focus:outline-none text-sm mb-3" placeholder="Enter memo name..." maxlength="50"/>
                    
                    <label for="memoDateInput" class="text-gray-700 font-medium block mb-1">Memo Date:</label>
                    <div class="relative mb-3">
                        <input type="text" id="memoDateInput" class="input-field w-full p-3 rounded-xl focus:outline-none text-sm pr-10" placeholder="DD/MM/YYYY" maxlength="10"/>
                        <div id="memoDateIcon" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-500 hover:text-indigo-500">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-3.75h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Zm0 2.25h.008v.008H16.5v-.008Z" />
                            </svg>
                        </div>
                    </div>
                    
                    <label for="memoWeekInput" class="text-gray-700 font-medium block mb-1">Memo Week:</label>
                    <input type="text" id="memoWeekInput" class="input-field w-full p-3 rounded-xl focus:outline-none text-sm" placeholder="WKX ofYYYY-YY" maxlength="15"/>
                </div>

                <div>
                    <div class="relative">
                         <label for="messageInput" class="text-gray-700 font-medium block mb-1 sr-only">Message Content:</label>
                        <textarea id="messageInput" class="input-field w-full p-4 rounded-2xl focus:outline-none resize-none" rows="4" placeholder="Enter your daily work message... 😊🚀"></textarea>
                        <div id="openLargeMessageInputModal" class="p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15.75M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15.75" />
                            </svg>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                            <span id="charCount" class="text-sm text-gray-500 font-medium">0 characters</span>
                            <span id="messageCount" class="counter-badge">0/53 memos</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md border border-gray-200">
                    <label class="text-gray-700 font-medium block mb-2">Importance Level:</label>
                    <div id="importanceButtonsContainer" class="flex flex-wrap gap-2 justify-center">
                        <button class="importance-button" data-importance="onTrack"><span class="importance-light light-on-track"></span>On track</button>
                        <button class="importance-button" data-importance="caution"><span class="importance-light light-caution"></span>Caution</button>
                        <button class="importance-button" data-importance="urgent"><span class="importance-light light-urgent"></span>Urgent</button>
                        <button class="importance-button" data-importance="complete"><span class="importance-light light-complete"></span>Complete</button>
                    </div>
                </div>

                <div>
                    <button id="saveButton" class="action-button primary-button w-full text-white px-6 py-4 rounded-2xl font-semibold text-lg transition-all duration-300" disabled>💾 Save Memo</button>
                </div>
                <!-- User Info and Logout Button -->
                <div id="userInfoContainer" class="p-3 rounded-xl mt-4 hidden">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-700">Logged in as: <strong id="userEmailDisplay" class="truncate"></strong></div>
                        <button id="logoutButton" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 transition-colors">Logout</button>
                    </div>
                </div>
                <p id="debugMessage" class="text-sm text-red-500 p-3 bg-red-50 rounded-xl hidden"></p>
            </div>
            
            <div class="lg:col-span-3">
                 <!-- Right Column Content (Memo Display Area) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                    <h2 id="currentMemoPageTitle" class="text-2xl font-semibold text-gray-700">Your Memos</h2>
                    <div class="flex flex-wrap items-center gap-2">
                        <div id="importanceFilterContainer" class="flex items-center gap-2">
                            <button class="filter-importance-button" data-filter="all"><span class="importance-light bg-gray-400"></span>All</button>
                            <button class="filter-importance-button" data-filter="onTrack"><span class="importance-light light-on-track"></span>On track</button>
                            <button class="filter-importance-button" data-filter="caution"><span class="importance-light light-caution"></span>Caution</button>
                            <button class="filter-importance-button" data-filter="urgent"><span class="importance-light light-urgent"></span>Urgent</button>
                            <button class="filter-importance-button" data-filter="complete"><span class="importance-light light-complete"></span>Complete</button>
                        </div>
                        <button id="exportButton" class="action-button primary-button text-white px-3 py-2 rounded-xl text-sm flex items-center gap-1">
                            📊 <span>Export to Excel</span>
                        </button>
                        <button id="globalSearchButton" class="action-button primary-button text-white px-3 py-2 rounded-xl text-sm flex items-center gap-1">
                            🔎 <span>Search Message</span>
                        </button>
                    </div>
                </div>
                <!-- Added for task 2: Message for disabled drag-and-drop -->
                <div id="filterNotificationArea" class="text-sm text-blue-700 bg-blue-100 p-3 rounded-xl my-3 hidden text-center"></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="memoDisplayArea">
                    <!-- Memos will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Large Message Input Modal -->
    <div id="largeMessageInputModal" class="modal-overlay fixed inset-0 flex items-center justify-center z-[100] hidden">
        <div class="modal-content large-message-input-modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-6 sm:p-8 shadow-2xl">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-3xl font-semibold text-gray-800">Enter your daily work message... 😊🚀</h3>
                <button id="closeLargeMessageInputModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                </button>
            </div>
            <div class="relative">
                <textarea id="largeMessageInputTextArea" class="large-message-textarea w-full p-3 rounded-xl focus:outline-none resize-y text-base" rows="15" placeholder="Enter your detailed memo content here..."></textarea>
                <div class="font-size-controls">
                    <button class="font-size-button" data-target="largeMessageInputTextArea" data-action="decrease">-</button>
                    <button class="font-size-button" data-target="largeMessageInputTextArea" data-action="increase">+</button>
                </div>
            </div>
            <!-- Buttons removed as per user request -->
        </div>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBOfrCOivIkOA0BzMQ8teMhMtglhhsj6aI",
            authDomain: "perrymemonotes.firebaseapp.com",
            databaseURL: "https://perrymemonotes-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "perrymemonotes",
            storageBucket: "perrymemonotes.appspot.com",
            messagingSenderId: "169391391927",
            appId: "1:169391391927:web:f045f75d77afcaa959b932"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let dbRef = null; // Will hold reference to user's data in DB

        // --- AUTHENTICATION ---

        // DOM Element References for Auth
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showLoginButton = document.getElementById('showLoginButton');
        const showRegisterButton = document.getElementById('showRegisterButton');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const userInfoContainer = document.getElementById('userInfoContainer');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const logoutButton = document.getElementById('logoutButton');

        // Toggle between login and register forms
        showLoginButton.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            showLoginButton.classList.add('active');
            showRegisterButton.classList.remove('active');
        });

        showRegisterButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            showLoginButton.classList.remove('active');
            showRegisterButton.classList.add('active');
        });

        // Handle Registration
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            registerError.textContent = '';

            if (password !== confirmPassword) {
                registerError.textContent = "Passwords do not match.";
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => {
                    registerError.textContent = error.message;
                });
        });

        // Handle Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            loginError.textContent = '';

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loginError.textContent = error.message;
                });
        });

        // Handle Logout
        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });


        // Auth State Observer
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userInfoContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;

                // Set up database reference for the logged-in user
                dbRef = db.ref(`users/${user.uid}/appData`);

                // Listen for data changes
                dbRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        loadDataFromFirebase(data);
                    } else {
                        // New user, set up default data
                        initializeDefaultData();
                    }
                    updateUI();
                });
                
                // Initialize the app state after login
                updateDateAndWeekInputs();

            } else {
                // User is signed out.
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                userInfoContainer.classList.add('hidden');

                // Detach the database listener
                if (dbRef) {
                    dbRef.off();
                }
                // Clear local state
                resetLocalState();
                updateUI();
            }
        });


        // --- APPLICATION LOGIC ---

        // DOM Element References
        const messageInput = document.getElementById('messageInput');
        const memoNameInput = document.getElementById('memoNameInput');
        const memoDateInput = document.getElementById('memoDateInput'); 
        const memoDateIcon = document.getElementById('memoDateIcon');
        const memoWeekInput = document.getElementById('memoWeekInput'); 
        const importanceButtonsContainer = document.getElementById('importanceButtonsContainer');
        const saveButton = document.getElementById('saveButton');
        const charCount = document.getElementById('charCount');
        const messageCount = document.getElementById('messageCount');
        const debugMessage = document.getElementById('debugMessage');
        const pagesContainer = document.getElementById('pagesContainer');
        const newPageNameInput = document.getElementById('newPageNameInput');
        const addPageButton = document.getElementById('addPageButton');
        const currentMemoPageTitle = document.getElementById('currentMemoPageTitle');
        const globalSearchButton = document.getElementById('globalSearchButton');
        const exportButton = document.getElementById('exportButton'); 
        const memoDisplayArea = document.getElementById('memoDisplayArea'); 
        const importanceFilterContainer = document.getElementById('importanceFilterContainer');
        const filterNotificationArea = document.getElementById('filterNotificationArea'); 
        const openLargeMessageInputModalButton = document.getElementById('openLargeMessageInputModal');
        const largeMessageInputModal = document.getElementById('largeMessageInputModal');
        const largeMessageInputTextArea = document.getElementById('largeMessageInputTextArea');
        const closeLargeMessageInputModalButton = document.getElementById('closeLargeMessageInputModalButton');
        const saveLargeMessageButton = document.getElementById('saveLargeMessageButton'); // Still needed for internal logic
        const cancelLargeMessageButton = document.getElementById('cancelLargeMessageButton'); // Still needed for internal logic


        // Global State Variables
        let pages = {}; 
        let pageOrder = []; 
        let currentPage = 'default'; 
        const maxMemos = 53; 
        const memoBgColors = [ 
            'memo-bg-0', 'memo-bg-1', 'memo-bg-2', 'memo-bg-3', 'memo-bg-4',
            'memo-bg-5', 'memo-bg-6', 'memo-bg-7', 'memo-bg-8', 'memo-bg-9',
            'memo-bg-10', 'memo-bg-11', 'memo-bg-12', 'memo-bg-13', 'memo-bg-14', 'memo-bg-15'
        ];
        const MAX_MEMO_LINES = 6; 
        let draggedMemoIndex = null; 
        let draggedMemoElement = null; 
        let draggedOverTargetElement = null; 
        let draggedPageName = null; 
        let draggedOverPageTargetElement = null; 
        let flatpickrInstance = null;

        const importanceLevels = {
            onTrack: { label: 'On track', lightClass: 'light-on-track', borderColorClass: 'importance-level-1' },
            caution: { label: 'Caution', lightClass: 'light-caution', borderColorClass: 'importance-level-5' },
            urgent: { label: 'Urgent', lightClass: 'light-urgent', borderColorClass: 'importance-level-9' },
            complete: { label: 'Complete', lightClass: 'light-complete', borderColorClass: 'importance-level-complete' }
        };
        let selectedImportance = null; 
        let currentFilter = 'all'; 

        // --- Font Size Adjustment ---
        const initialFontSize = 16; // Base font size in px for adjustable textareas/divs like modals
        const minFontSize = 10;
        const maxFontSize = 30;
        const fontSizeStep = 2; // Step for adjusting font size

        function adjustFontSize(element, change) {
            let currentSize = parseFloat(getComputedStyle(element).fontSize);
            let newLineHeight = parseFloat(getComputedStyle(element).lineHeight); // Get current line height

            // If line-height is 'normal', calculate based on current font size or a default ratio
            if (getComputedStyle(element).lineHeight === 'normal' || newLineHeight === 0) {
                newLineHeight = currentSize * 1.5; // Default ratio 1.5 for proportional adjustment
            }

            let newSize = currentSize + change;
            
            newSize = Math.max(minFontSize, Math.min(maxFontSize, newSize));

            // Adjust line height proportionally
            let lineHeightRatio = newLineHeight / currentSize; // Calculate current ratio
            newLineHeight = newSize * lineHeightRatio; // Apply ratio to new font size

            element.style.fontSize = `${newSize}px`;
            element.style.lineHeight = `${newLineHeight}px`;
        }

        // Event listener for font size buttons
        document.addEventListener('click', (e) => {
            const button = e.target.closest('.font-size-button');
            if (button) {
                const targetId = button.dataset.target;
                const action = button.dataset.action;
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    if (action === 'increase') {
                        adjustFontSize(targetElement, fontSizeStep);
                    } else if (action === 'decrease') {
                        adjustFontSize(targetElement, -fontSizeStep);
                    }
                }
            }
        });

        // Event listener for mouse scroll wheel + Ctrl key
        document.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                const targetElements = [
                    document.getElementById('largeMessageInputTextArea'),
                    document.getElementById('memoDetailsContent'), // The div that holds content in details modal
                    document.getElementById('editMemoContentInput') // The textarea in edit modal
                ];

                let target = null;
                // Check if the event target or its parent is one of the desired text areas
                for (const el of targetElements) {
                    if (el && (el.contains(e.target) || el === e.target)) {
                        target = el;
                        break;
                    }
                }

                if (target) {
                    e.preventDefault(); // Prevent page zooming
                    if (e.deltaY < 0) { // Scroll up (zoom in)
                        adjustFontSize(target, fontSizeStep);
                    } else { // Scroll down (zoom out)
                        adjustFontSize(target, -fontSizeStep);
                    }
                }
            }
        }, { passive: false }); // Use passive: false to allow preventDefault


        // --- Utility Functions ---

        function getRandomMemoBgClass() { return memoBgColors[Math.floor(Math.random() * memoBgColors.length)]; }
        
        function getImportanceBorderClass(importance) { 
            return importanceLevels[importance] ? importanceLevels[importance].borderColorClass : '';
        }
        function getImportanceLightClass(importance) {
            return importanceLevels[importance] ? importanceLevels[importance].lightClass : '';
        }
        function getImportanceLabel(importance) {
            return importanceLevels[importance] ? importanceLevels[importance].label : '';
        }

        function showNotification(messageText, type = 'success') { // Added type for different notification styles
            const notification = document.createElement('div'); 
            notification.className = 'floating-notification'; 
            if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'; // Red gradient for error
                notification.style.boxShadow = '0 10px 25px rgba(239, 68, 68, 0.4)';
            } else if (type === 'info') {
                notification.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'; // Blue gradient for info
                notification.style.boxShadow = '0 10px 25px rgba(59, 130, 246, 0.4)';
            }
            notification.textContent = messageText; 
            document.body.appendChild(notification); 
            setTimeout(() => { 
                notification.classList.add('hide'); 
                setTimeout(() => notification.remove(), 400); 
            }, 2000); 
        }

        function showInputModal(title, placeholder, initialValue, maxLength, onSave, onCancel) { 
            const overlay = document.createElement('div'); 
            overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50'; 
            const modal = document.createElement('div'); 
            modal.className = 'modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-8 max-w-md w-full mx-4'; 
            modal.innerHTML = `<div class="text-center mb-6"><div class="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center"><span class="text-2xl">📝</span></div><h3 class="text-xl font-semibold text-gray-800 mb-2">${title}</h3><p class="text-gray-600 text-sm mb-4">Enter a name for your item</p><input type="text" id="modalInput" class="input-field w-full p-3 rounded-xl focus:outline-none" placeholder="${placeholder}" maxlength="${maxLength}"/><p class="text-xs text-gray-500 mt-2">Max ${maxLength} characters</p></div><div class="flex space-x-3"><button class="cancel-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Cancel</button><button class="primary-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Save</button></div>`; 
            overlay.appendChild(modal); 
            document.body.appendChild(overlay); 
            const inputField = modal.querySelector('#modalInput'); 
            const saveBtn = modal.querySelector('.primary-button'); 
            const cancelBtn = modal.querySelector('.cancel-button'); 
            inputField.value = initialValue; 
            inputField.focus(); 
            inputField.select(); 
            saveBtn.addEventListener('click', () => { 
                const value = inputField.value.trim(); 
                if (value) { 
                    onSave(value); 
                    overlay.remove(); 
                } else { 
                    inputField.focus(); 
                    inputField.style.borderColor = '#ef4444'; 
                    setTimeout(() => inputField.style.borderColor = '', 2000); 
                } 
            }); 
            cancelBtn.addEventListener('click', () => { onCancel(); overlay.remove(); }); 
            inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveBtn.click(); }); 
        }
        
        function showEditMemoModal(memoData, onSave, onCancel) { 
            const overlay = document.createElement('div'); 
            overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-[100]'; 
            const modal = document.createElement('div'); 
            modal.className = 'modal-content edit-memo-modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-6 sm:p-8 shadow-2xl'; 
            
            let selectedBgColorClass = memoData.bgColorClass; 
            let currentEditImportance = memoData.importance; 

            const colorSwatchesHtml = memoBgColors.map(colorClass => `
                <div class="color-swatch ${colorClass} ${selectedBgColorClass === colorClass ? 'selected' : ''}" data-color-class="${colorClass}"></div>
            `).join('');

            const importanceButtonsHtml = Object.keys(importanceLevels).map(key => `
                <button class="importance-button ${currentEditImportance === key ? 'selected' : ''}" data-importance="${key}">
                    <span class="importance-light ${importanceLevels[key].lightClass}"></span>
                    ${importanceLevels[key].label}
                </button>
            `).join('');

            modal.innerHTML = `
                <div>
                    <h3 class="text-3xl font-semibold text-gray-800 mb-6 text-center">Edit Memo</h3>
                    <div class="mb-4">
                        <label for="editMemoNameInput" class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                        <input type="text" id="editMemoNameInput" class="input-field w-full p-3 rounded-xl focus:outline-none text-base" value="${memoData.name}" maxlength="50">
                    </div>
                    <div class="mb-4 relative">
                        <label for="editMemoContentInput" class="block text-sm font-medium text-gray-700 mb-1">Content:</label>
                        <textarea id="editMemoContentInput" class="input-field w-full p-3 rounded-xl focus:outline-none resize-y text-base" rows="8">${memoData.content}</textarea>
                        <div class="font-size-controls">
                            <button class="font-size-button" data-target="editMemoContentInput" data-action="decrease">-</button>
                            <button class="font-size-button" data-target="editMemoContentInput" data-action="increase">+</button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Importance Level:</label>
                        <div id="editImportanceButtonsContainer" class="flex flex-wrap gap-2 justify-center">
                            ${importanceButtonsHtml}
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Memo Color:</label>
                        <div id="colorSwatchesContainer" class="flex flex-wrap gap-3 justify-center">
                            ${colorSwatchesHtml}
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="editModalCancelButton" class="cancel-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Cancel</button>
                        <button id="editModalSaveButton" class="save-edit-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Save Changes</button>
                    </div>
                </div>
            `; 
            overlay.appendChild(modal); 
            document.body.appendChild(overlay); 
            document.body.style.overflow = 'hidden'; 
            
            const nameInput = modal.querySelector('#editMemoNameInput'); 
            const contentInput = modal.querySelector('#editMemoContentInput'); 
            const editImportanceButtonsContainer = modal.querySelector('#editImportanceButtonsContainer');
            const colorSwatchesContainer = modal.querySelector('#colorSwatchesContainer');
            const saveBtn = modal.querySelector('#editModalSaveButton'); 
            const cancelBtn = modal.querySelector('#editModalCancelButton'); 
            
            editImportanceButtonsContainer.addEventListener('click', (e) => {
                const clickedButton = e.target.closest('.importance-button');
                if (clickedButton) {
                    editImportanceButtonsContainer.querySelectorAll('.importance-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    clickedButton.classList.add('selected');
                    currentEditImportance = clickedButton.dataset.importance;
                }
            });

            colorSwatchesContainer.addEventListener('click', (e) => {
                const clickedSwatch = e.target.closest('.color-swatch');
                if (clickedSwatch) {
                    colorSwatchesContainer.querySelectorAll('.color-swatch').forEach(swatch => {
                        swatch.classList.remove('selected');
                    });
                    clickedSwatch.classList.add('selected');
                    selectedBgColorClass = clickedSwatch.dataset.colorClass; 
                }
            });

            saveBtn.addEventListener('click', () => { 
                const newName = nameInput.value.trim(); 
                const newContent = contentInput.value; 
                const newBgColorClass = selectedBgColorClass; 
                const newImportance = currentEditImportance;

                if (newName && newContent.trim() && newImportance) { 
                    onSave({ name: newName, content: newContent, importance: newImportance, bgColorClass: newBgColorClass }); 
                    document.body.style.overflow = ''; 
                    overlay.remove(); 
                } else { 
                    showNotification('Name, content, and importance cannot be empty.', 'error'); 
                } 
            }); 
            const closeModal = () => { document.body.style.overflow = ''; overlay.remove(); onCancel(); }; 
            cancelBtn.addEventListener('click', closeModal); 
            nameInput.focus(); 
        }
        function showDeleteConfirmationModal(itemType, itemName, onDeleteConfirm) { 
            const overlay = document.createElement('div'); 
            overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50'; 
            const modal = document.createElement('div'); 
            modal.className = 'modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-8 max-w-sm w-full mx-4 text-center'; 
            modal.innerHTML = `<div class="mb-6"><div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center"><span class="text-2xl">🗑️</span></div><h3 class="text-xl font-semibold text-gray-800 mb-2">Delete ${itemType}</h3><p class="text-gray-600">Are you sure you want to delete "${itemName}"? This action cannot be undone.</p></div><div class="flex space-x-3"><button class="cancel-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Cancel</button><button class="delete-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Delete</button></div>`; 
            overlay.appendChild(modal); 
            document.body.appendChild(overlay); 
            const deleteButton = modal.querySelector('.delete-button'); 
            const cancelButton = modal.querySelector('.cancel-button'); 
            deleteButton.addEventListener('click', () => { onDeleteConfirm(); overlay.remove(); showNotification(`${itemType} deleted successfully!`); }); 
            cancelButton.addEventListener('click', () => overlay.remove()); 
        }
        async function copyToClipboard(text, sourceElement) { 
            if (sourceElement.dataset.isEditing === 'true') { 
                showNotification('Cannot copy while editing.', 'info');
                return;
            }

            try {
                if (navigator.clipboard && window.isSecureContext) { 
                    await navigator.clipboard.writeText(text);
                    showNotification('Memo content copied! 📋');
                } else { 
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showNotification('Memo content copied! 📋');
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            } catch (err) {
                console.error('Failed to copy:', err);
                debugMessage.textContent = 'Copy failed. Ensure page is HTTPS or try another browser.';
                debugMessage.classList.remove('hidden');
                setTimeout(() => { debugMessage.classList.add('hidden'); }, 3000);
            }
        }

        function showMemoDetailsModal(memoData, pageName, memoIndex) { // MODIFIED
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-[100]';
            const modal = document.createElement('div');
            modal.className = 'modal-content memo-details-modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-6 sm:p-8 shadow-2xl';
            
            const date = new Date(memoData.timestamp);
            const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            const formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const displayTimestamp = `${formattedDate} ${formattedTime}`;

            const originalContent = memoData.content; 

            const nameParts = memoData.name.split(' - ', 2);
            const baseName = nameParts[0] || memoData.name;
            const dateAndWeekPart = nameParts[1] ? `<br>${nameParts[1]}` : '';

            modal.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-3xl font-semibold text-gray-800">${baseName}${dateAndWeekPart}</h3>
                        <button id="closeDetailsModalButton" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div class="mb-4 flex items-center gap-4">
                        <div class="modal-importance-display">
                            <div class="importance-light ${getImportanceLightClass(memoData.importance)}"></div>
                            <span>Importance: ${getImportanceLabel(memoData.importance)}</span>
                        </div>
                        <input type="text" id="detailsSearchInput" class="input-field flex-1 p-2 rounded-xl focus:outline-none text-sm" placeholder="Search within memo content...">
                    </div>
                    <div class="mb-6 relative">
                        <label for="memoDetailsContent" class="block text-sm font-medium text-gray-700 mb-1">Content:</label>
                        <div id="memoDetailsContent" class="memo-details-content-area text-base text-gray-700 p-3 rounded-xl bg-gray-50 border border-gray-200 ${getImportanceBorderClass(memoData.importance)}">
                            </div>
                        <div class="font-size-controls">
                            <button class="font-size-button" data-target="memoDetailsContent" data-action="decrease">-</button>
                            <button class="font-size-button" data-target="memoDetailsContent" data-action="increase">+</button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 text-right">${displayTimestamp}</p>
                    <div class="flex flex-col sm:flex-row gap-3 mt-6">
                        <button id="detailsModalCopyButton" class="copy-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Copy</button>
                        <button id="detailsModalEditButton" class="edit-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Edit</button>
                        <button id="detailsModalDeleteButton" class="delete-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Delete</button>
                    </div>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            const detailsContentDiv = modal.querySelector('#memoDetailsContent');
            const detailsSearchInput = modal.querySelector('#detailsSearchInput');

            const renderContentWithHighlight = (content, searchTerm) => {
                if (!searchTerm) {
                    detailsContentDiv.textContent = content;
                    return;
                }
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                const regex = new RegExp(`(${lowerCaseSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                detailsContentDiv.innerHTML = content.replace(regex, '<mark class="bg-yellow-200 rounded">$1</mark>');

                const firstHighlight = detailsContentDiv.querySelector('mark');
                if (firstHighlight) {
                    firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };

            renderContentWithHighlight(originalContent, '');

            detailsSearchInput.addEventListener('input', (e) => {
                renderContentWithHighlight(originalContent, e.target.value);
            });
            detailsSearchInput.focus(); 

            document.body.style.overflow = 'hidden'; 

            const closeBtn = modal.querySelector('#closeDetailsModalButton');
            const copyBtn = modal.querySelector('#detailsModalCopyButton');
            const editBtn = modal.querySelector('#detailsModalEditButton');
            const deleteBtn = modal.querySelector('#detailsModalDeleteButton');

            const closeModal = () => {
                document.body.style.overflow = ''; 
                overlay.remove();
            };

            closeBtn.addEventListener('click', closeModal);

            copyBtn.addEventListener('click', () => {
                copyToClipboard(memoData.content, modal); 
            });

            editBtn.addEventListener('click', () => {
                closeModal(); 
                const memoElement = document.querySelector(`.memo-note[data-memo-id="${pageName}-${memoIndex}"]`); // MODIFIED
                if (memoElement) {
                    editMemo(pageName, memoIndex, memoElement); // MODIFIED
                } else {
                     // If the element isn't in the DOM (e.g., due to filtering), create a dummy object
                     // for the isEditing flag to prevent errors, and proceed with the edit logic.
                    const dummyElement = { dataset: {} };
                    editMemo(pageName, memoIndex, dummyElement);
                    showNotification('Editing memo. The list may not update until the filter is cleared.', 'info');
                }
            });

            deleteBtn.addEventListener('click', () => {
                closeModal(); 
                showDeleteConfirmationModal('Memo', memoData.name, () => deleteMemo(pageName, memoIndex)); // MODIFIED
            });
        }

        // --- Data Persistence (Firebase Realtime Database) ---

        function loadDataFromFirebase(data) {
            pages = data.pages || { 'default': [] };
            pageOrder = data.pageOrder || ['default'];
            currentPage = data.currentPage || 'default';

            // BUG FIX: Ensure every page in pageOrder has an entry in the pages object.
            // This prevents pages with no memos from disappearing on load from Firebase,
            // because Firebase doesn't store empty arrays/objects.
            if (pageOrder) {
                pageOrder.forEach(pName => {
                    if (!pages[pName]) {
                        pages[pName] = [];
                    }
                });
            }
        }

        function resetLocalState() {
            pages = {};
            pageOrder = [];
            currentPage = 'default';
        }

        function initializeDefaultData() {
            pages = { 'default': [] };
            pageOrder = ['default'];
            currentPage = 'default';
            saveAllData();
        }

        function saveAllData() { 
            if (dbRef) {
                dbRef.set({
                    pages: pages,
                    pageOrder: pageOrder,
                    currentPage: currentPage
                });
            }
        }

        // --- Page Management Functions ---

        function addPage(pageName) { 
            if (pages[pageName]) { 
                showNotification(`Page "${pageName}" already exists!`, 'info'); 
                return; 
            } 
            pages[pageName] = []; 
            if(!pageOrder.includes(pageName)) pageOrder.push(pageName); 
            currentPage = pageName; 
            saveAllData(); 
            // updateUI(); // Not needed here, Firebase on() listener will trigger it
            showNotification(`Page "${pageName}" created! 🎉`); 
        }
        function switchPage(pageName) { 
            if (currentPage === pageName) return; 
            currentPage = pageName; 
            saveAllData(); 
            // updateUI(); // Not needed here, Firebase on() listener will trigger it
            showNotification(`Switched to page: "${pageName}"`, 'info'); 
        }
        function editPageName(oldPageName) { 
            showInputModal('Edit Page Name', 'Enter new page name...', oldPageName, 20, 
                (newPageName) => { 
                    if (newPageName === oldPageName) { 
                        showNotification('Page name not changed.', 'info'); 
                        return; 
                    } 
                    if (Object.keys(pages).some(p => p.toLowerCase() === newPageName.toLowerCase())) { 
                        showNotification(`Page "${newPageName}" already exists!`, 'error'); 
                        return; 
                    } 
                    const pageMessages = pages[oldPageName]; 
                    delete pages[oldPageName]; 
                    pages[newPageName] = pageMessages; 
                    const oldIndex = pageOrder.indexOf(oldPageName); 
                    if(oldIndex > -1) pageOrder.splice(oldIndex, 1, newPageName); 
                    else pageOrder.push(newPageName); 
                    if (currentPage === oldPageName) currentPage = newPageName; 
                    saveAllData(); 
                    // updateUI(); // Not needed here, Firebase on() listener will trigger it
                    showNotification(`Page "${oldPageName}" renamed to "${newPageName}"!`); 
                }, 
                () => {} 
            ); 
        }
        function deletePage(pageName) { 
            showDeleteConfirmationModal('Page', pageName, () => { 
                delete pages[pageName]; 
                pageOrder = pageOrder.filter(p => p !== pageName); 
                if (pageOrder.length === 0) { 
                    pages['default'] = []; 
                    pageOrder.push('default'); 
                } 
                if (currentPage === pageName) currentPage = pageOrder[0] || 'default'; 
                saveAllData(); 
                // updateUI(); // Not needed here, Firebase on() listener will trigger it
            }); 
        }
        
        function renderPages() { 
            pagesContainer.innerHTML = ''; 
            if (!pageOrder) return;
            pageOrder.forEach(pageName => { 
                // This check is now safe because loadDataFromFirebase ensures pages[pageName] exists.
                if (!pages[pageName]) return; 
                const pageButton = document.createElement('button'); 
                pageButton.className = `action-button px-4 py-2 rounded-xl font-medium text-sm transition-all duration-200 ${currentPage === pageName ? 'primary-button text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`; 
                pageButton.textContent = pageName; 
                pageButton.dataset.pageName = pageName; 
                pageButton.setAttribute('draggable', 'true'); 

                pageButton.addEventListener('click', () => switchPage(pageName)); 
                pageButton.addEventListener('contextmenu', (e) => { e.preventDefault(); showPageContextMenu(e.clientX, e.clientY, pageName); }); 
                
                pageButton.addEventListener('dragstart', handlePageDragStart);
                pageButton.addEventListener('dragover', handlePageDragOver);
                pageButton.addEventListener('dragleave', handlePageDragLeave);
                pageButton.addEventListener('drop', handlePageDrop);
                pageButton.addEventListener('dragend', handlePageDragEnd);

                pagesContainer.appendChild(pageButton); 
            }); 
        }
        function showPageContextMenu(x, y, pageName) { 
            const existingMenu = document.getElementById('pageContextMenu'); 
            if (existingMenu) existingMenu.remove(); 
            const menu = document.createElement('div'); 
            menu.id = 'pageContextMenu'; 
            menu.className = 'absolute bg-white rounded-lg shadow-lg py-2 z-50 text-sm'; 
            menu.style.left = `${x}px`; 
            menu.style.top = `${y}px`; 
            menu.style.minWidth = '120px'; 
            const editItem = document.createElement('button'); 
            editItem.className = 'block w-full text-left px-4 py-2 hover:bg-gray-100'; 
            editItem.textContent = 'Edit Name'; 
            editItem.addEventListener('click', () => { editPageName(pageName); menu.remove(); }); 
            const deleteItem = document.createElement('button'); 
            deleteItem.className = 'block w-full text-left px-4 py-2 text-red-600 hover:bg-red-50'; 
            deleteItem.textContent = 'Delete Page'; 
            deleteItem.addEventListener('click', () => { deletePage(pageName); menu.remove(); }); 
            menu.appendChild(editItem); 
            if (pageOrder.length > 1) menu.appendChild(deleteItem); 
            document.body.appendChild(menu); 
            const closeMenu = (event) => { 
                    menu.remove(); 
                    document.removeEventListener('click', closeMenu); 
                    document.removeEventListener('contextmenu', closeMenu); 
            }; 
            setTimeout(() => { 
                document.addEventListener('click', closeMenu); 
                document.removeEventListener('contextmenu', closeMenu); 
            }, 0); 
        }

        // --- Memo Drag and Drop Handlers ---
        function handleDragStart(event) {
            if (currentFilter !== 'all') {
                event.preventDefault(); 
                showNotification('Drag and drop is disabled when a filter is active.', 'info');
                return;
            }

            draggedMemoElement = event.target;
            draggedMemoIndex = parseInt(draggedMemoElement.dataset.index);
            draggedMemoElement.classList.add('dragging'); 
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedMemoIndex); 
        }

        function handleDragOver(event) {
            if (currentFilter !== 'all') {
                return;
            }
            event.preventDefault(); 
            const targetMemo = event.target.closest('.memo-note');

            if (draggedOverTargetElement && draggedOverTargetElement !== targetMemo) {
                draggedOverTargetElement.classList.remove('drag-target-glow');
                draggedOverTargetElement = null;
            }

            if (targetMemo && targetMemo !== draggedMemoElement) {
                targetMemo.classList.add('drag-target-glow');
                draggedOverTargetElement = targetMemo;
            } else if (!targetMemo && (event.target.id === 'memoDisplayArea' || event.target.closest('#memoDisplayArea'))) {
                if (draggedOverTargetElement) {
                    draggedOverTargetElement.classList.remove('drag-target-glow');
                    draggedOverTargetElement = null;
                }
            }
        }
        
        function handleDragLeave(event) {
            if (currentFilter !== 'all') {
                return;
            }
            if (draggedOverTargetElement) {
                draggedOverTargetElement.classList.remove('drag-target-glow');
                draggedOverTargetElement = null;
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            if (currentFilter !== 'all') {
                return;
            }
            
            if (draggedOverTargetElement) {
                draggedOverTargetElement.classList.remove('drag-target-glow');
                draggedOverTargetElement = null;
            }

            if (draggedMemoIndex === null) {
                if(draggedMemoElement) draggedMemoElement.classList.remove('dragging');
                draggedMemoIndex = null;
                draggedMemoElement = null;
                return;
            }

            const memosInPage = pages[currentPage];
            if (!memosInPage) return; // Safety check
            const memoToMove = memosInPage.splice(draggedMemoIndex, 1)[0]; 
            
            const targetMemo = event.target.closest('.memo-note');
            let newIndex;

            if (targetMemo && targetMemo !== draggedMemoElement) {
                const allMemos = Array.from(memoDisplayArea.querySelectorAll('.memo-note'));
                const targetIndexInDisplayed = allMemos.indexOf(targetMemo);
                
                // Convert displayed index back to original index in the source array
                const targetDatasetIndex = parseInt(targetMemo.dataset.index);

                const rect = targetMemo.getBoundingClientRect();
                const isAfter = event.clientX > rect.left + rect.width / 2;
                
                newIndex = targetDatasetIndex;
                if (isAfter) {
                    newIndex = targetDatasetIndex + 1;
                }
                
                if (draggedMemoIndex < newIndex) {
                    newIndex--; 
                }

            } else {
                newIndex = memosInPage.length; 
            }
            
            memosInPage.splice(newIndex, 0, memoToMove);
            
            saveAllData();
            // updateMemoList(); // Not needed, handled by Firebase listener
            
            if(draggedMemoElement) draggedMemoElement.classList.remove('dragging');
            draggedMemoIndex = null;
            draggedMemoElement = null;
        }
        
        function handleDragEnd(event) {
            if (currentFilter !== 'all') {
                if(draggedMemoElement) draggedMemoElement.classList.remove('dragging');
                if(draggedOverTargetElement) draggedOverTargetElement.classList.remove('drag-target-glow');
                draggedMemoIndex = null;
                draggedMemoElement = null;
                draggedOverTargetElement = null;
                return;
            }

            if(draggedMemoElement) draggedMemoElement.classList.remove('dragging');
            if(draggedOverTargetElement) draggedOverTargetElement.classList.remove('drag-target-glow');
            draggedMemoIndex = null;
            draggedMemoElement = null;
            draggedOverTargetElement = null;
        }


        // --- Memo List Management ---

        function updateMemoList() {
            memoDisplayArea.innerHTML = ''; 
            let currentMemosSource = pages[currentPage] || [];
            // Firebase returns objects, not arrays for lists. Convert to array if needed.
            if (currentMemosSource && !Array.isArray(currentMemosSource)) {
                currentMemosSource = Object.values(currentMemosSource);
            }

            let displayedMemos = currentMemosSource;

            if (currentFilter !== 'all') {
                displayedMemos = currentMemosSource.filter(memo => memo && memo.importance === currentFilter);
            }

            const isDraggable = currentFilter === 'all';

            displayedMemos.forEach((memoObj) => { 
                if (!memoObj) return; // Skip if memo object is null/undefined

                const originalIndex = currentMemosSource.indexOf(memoObj); 

                const memoContainer = document.createElement('div');
                memoContainer.dataset.isEditing = 'false'; 
                memoContainer.dataset.index = originalIndex; 
                memoContainer.dataset.memoId = `${currentPage}-${originalIndex}`; 
                
                memoContainer.setAttribute('draggable', isDraggable);
                if (!isDraggable) {
                    memoContainer.classList.add('cursor-not-allowed');
                } else {
                    memoContainer.classList.remove('cursor-not-allowed');
                }

                memoContainer.className = `memo-note relative p-4 rounded-xl shadow-md ${memoObj.bgColorClass} ${getImportanceBorderClass(memoObj.importance)}`;
                
                if (isDraggable) { 
                    memoContainer.addEventListener('dragstart', handleDragStart);
                    memoContainer.addEventListener('dragover', handleDragOver); 
                    memoContainer.addEventListener('dragleave', handleDragLeave); 
                    memoContainer.addEventListener('drop', handleDrop);      
                    memoContainer.addEventListener('dragend', handleDragEnd);
                }

                memoContainer.addEventListener('click', (e) => { 
                    if (!e.target.closest('.memo-actions button') && memoContainer.dataset.isEditing === 'false' && !memoContainer.classList.contains('dragging')) { 
                        showMemoDetailsModal(memoObj, currentPage, originalIndex); // MODIFIED
                    } 
                });

                const nameParts = memoObj.name.split(' - ', 2);
                const baseName = nameParts[0] || memoObj.name;
                const dateAndWeekPart = nameParts[1] ? `<br>${nameParts[1]}` : '';

                const headerDiv = document.createElement('div'); 
                headerDiv.className = "flex justify-between items-start mb-1"; 
                headerDiv.innerHTML = `<div class="font-semibold text-gray-800 text-sm truncate pr-16 pointer-events-none">${baseName}${dateAndWeekPart}</div>`; 
                memoContainer.appendChild(headerDiv);

                const contentArea = document.createElement('div'); 
                contentArea.className = "flex-grow overflow-hidden mb-1 pointer-events-none"; 
                const contentText = document.createElement('div'); 
                contentText.className = 'memo-content-text text-sm text-gray-700 h-full'; 
                const lines = memoObj.content.split('\n');
                if (lines.length > MAX_MEMO_LINES) { 
                    const lastVisibleLine = lines[MAX_MEMO_LINES -1]; 
                    contentText.textContent = lines.slice(0, MAX_MEMO_LINES-1).join('\n') + '\n' + lastVisibleLine + ' ...'; 
                } else { 
                    contentText.textContent = memoObj.content.trim(); 
                }
                contentArea.appendChild(contentText); 
                memoContainer.appendChild(contentArea);
                
                const timestampDiv = document.createElement('div'); 
                timestampDiv.className = 'memo-timestamp pointer-events-none'; 
                const date = new Date(memoObj.timestamp); 
                const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`; 
                const formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); 
                timestampDiv.textContent = `${formattedDate} ${formattedTime}`; 
                memoContainer.appendChild(timestampDiv);
                
                const importanceDisplayDiv = document.createElement('div');
                importanceDisplayDiv.className = 'importance-display';
                importanceDisplayDiv.innerHTML = `
                    <div class="importance-light ${getImportanceLightClass(memoObj.importance)}"></div>
                    <span>${getImportanceLabel(memoObj.importance)}</span>
                `;
                memoContainer.appendChild(importanceDisplayDiv);

                const actionsDiv = document.createElement('div'); 
                actionsDiv.className = 'memo-actions'; 
                actionsDiv.innerHTML = `
                    <button class="copy-button action-button text-white px-2 py-1 rounded-lg font-medium text-xs">Copy</button>
                    <button class="edit-button action-button text-white px-2 py-1 rounded-lg font-medium text-xs">Edit</button>
                    <button class="delete-button action-button text-white px-2 py-1 rounded-lg font-medium text-xs">Del</button>
                `; 
                memoContainer.appendChild(actionsDiv);

                actionsDiv.querySelector('.copy-button').addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    copyToClipboard(memoObj.content, memoContainer); 
                });
                actionsDiv.querySelector('.edit-button').addEventListener('click', (e) => { e.stopPropagation(); editMemo(currentPage, originalIndex, memoContainer); }); // MODIFIED
                actionsDiv.querySelector('.delete-button').addEventListener('click', (e) => { e.stopPropagation(); showDeleteConfirmationModal('Memo', memoObj.name, () => deleteMemo(currentPage, originalIndex)); }); // MODIFIED
                
                memoDisplayArea.appendChild(memoContainer);
            });
            
            if (isDraggable) { 
                memoDisplayArea.addEventListener('dragover', handleDragOver); 
                memoDisplayArea.addEventListener('dragleave', handleDragLeave); 
                memoDisplayArea.addEventListener('drop', handleDrop); 
            } else { 
                memoDisplayArea.removeEventListener('dragover', handleDragOver);
                memoDisplayArea.removeEventListener('dragleave', handleDragLeave);
                memoDisplayArea.removeEventListener('drop', handleDrop);
            }

            messageCount.textContent = `${displayedMemos.length}/${maxMemos} memos`; 
            updateSaveButtonState();
        }
        
        function editMemo(pageName, index, memoElement) { // MODIFIED
            memoElement.dataset.isEditing = 'true'; 
            const currentMemo = pages[pageName] && pages[pageName][index]; 

            if (!currentMemo) {
                showNotification('Could not find the memo to edit. It might have been moved or deleted.', 'error');
                memoElement.dataset.isEditing = 'false'; 
                return;
            }

            showEditMemoModal(currentMemo, 
                (updatedData) => { 
                    // Re-check existence in case of race conditions
                    if (pages[pageName] && pages[pageName][index]) {
                        pages[pageName][index] = { 
                            ...currentMemo, 
                            name: updatedData.name, 
                            content: updatedData.content, 
                            importance: updatedData.importance, 
                            bgColorClass: updatedData.bgColorClass, 
                            timestamp: Date.now(), 
                        }; 
                        saveAllData(); 
                        showNotification('Memo updated! ✨'); 
                    } else {
                        showNotification('Failed to save. The original memo could not be found.', 'error');
                    }
                    memoElement.dataset.isEditing = 'false'; 
                }, 
                () => { 
                    memoElement.dataset.isEditing = 'false'; 
                }
            ); 
        }
        function deleteMemo(pageName, index) { // MODIFIED
            if (pages[pageName]) {
                pages[pageName].splice(index, 1); 
            }
            saveAllData(); 
            // updateMemoList() is not needed, handled by Firebase listener
        }
        
        // --- Date and Week Calculation Helpers ---

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); 
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function getWeekdayAbbreviation(date) {
            const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            return weekdays[date.getDay()];
        }

        function parseDateString(dateString) {
            const parts = dateString.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; 
                const year = parseInt(parts[2], 10);
                if (year > 0 && month >= 0 && month < 12 && day > 0 && day <= 31) {
                    const date = new Date(year, month, day);
                    if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                        return date;
                    }
                }
            }
            return null; 
        }

        function getFinancialYearStartDate(year) {
            let may1 = new Date(year, 4, 1); 
            let dayOfWeek = may1.getDay(); 
            let daysToAdd = (7 - dayOfWeek) % 7; 
            may1.setDate(may1.getDate() + daysToAdd);
            may1.setHours(0, 0, 0, 0); 
            return may1;
        }

        function calculateFinancialWeek(date) {
            const currentCalYear = date.getFullYear();
            const fyStartCurrentCalYear = getFinancialYearStartDate(currentCalYear);
            const fyStartPrevCalYear = getFinancialYearStartDate(currentCalYear - 1);

            let actualFYStart; 
            let actualFYLabel; 
            let nextFYStartForActualFY; 
            if (date < fyStartCurrentCalYear) { 
                actualFYStart = fyStartPrevCalYear;
                actualFYLabel = currentCalYear - 1;
                nextFYStartForActualFY = fyStartCurrentCalYear;
            } else { 
                actualFYStart = fyStartCurrentCalYear;
                actualFYLabel = currentCalYear;
                nextFYStartForActualFY = getFinancialYearStartDate(currentCalYear + 1);
            }

            const daysInActualFY = Math.floor((nextFYStartForActualFY - actualFYStart) / (1000 * 60 * 60 * 24));
            const is53WeekYear = (daysInActualFY === 371); 

            const diffDaysFromActualFYStart = Math.floor((date - actualFYStart) / (1000 * 60 * 60 * 24));
            let weekNumber = Math.floor(diffDaysFromActualFYStart / 7) + 1;

            if (is53WeekYear && weekNumber > 53) {
                weekNumber = 53; 
            } else if (!is53WeekYear && weekNumber > 52) {
                weekNumber = 52; 
            }
            if (weekNumber <=0) weekNumber = 1; 

            const startYearShort = String(actualFYLabel).slice(-2);
            const endYearShort = String(actualFYLabel + 1).slice(-2);
            return `WK${weekNumber} (${startYearShort}-${endYearShort})`;
        }

        function updateDateAndWeekInputs() {
            const today = new Date();
            if (flatpickrInstance) {
                flatpickrInstance.setDate(today, true); 
            } else {
                memoDateInput.value = formatDate(today);
                updateMemoWeekBasedOnDateInput();
            }
        }

        function updateMemoWeekBasedOnDateInput() {
            const dateString = memoDateInput.value.trim();
            const parsedDate = parseDateString(dateString);
            if (parsedDate) {
                memoWeekInput.value = calculateFinancialWeek(parsedDate);
            } else {
                memoWeekInput.value = ''; 
            }
        }

        // --- Input Handling and Saving ---

        function updateSaveButtonState() { 
            const messageLength = messageInput.value.trim().length; 
            const nameLength = memoNameInput.value.trim().length; 
            const dateLength = memoDateInput.value.trim().length; 
            const weekLength = memoWeekInput.value.trim().length; 
            const currentMemos = pages[currentPage] || [];
            const totalMemosOnPage = Array.isArray(currentMemos) ? currentMemos.length : 0;
            saveButton.disabled = messageLength === 0 || nameLength === 0 || dateLength === 0 || weekLength === 0 || totalMemosOnPage >= maxMemos || selectedImportance === null; 
        }

        importanceButtonsContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.importance-button');
            if (clickedButton) {
                importanceButtonsContainer.querySelectorAll('.importance-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                clickedButton.classList.add('selected');
                selectedImportance = clickedButton.dataset.importance; 
                updateSaveButtonState(); 
            }
        });

        messageInput.addEventListener('input', () => { 
            charCount.textContent = `${messageInput.value.length} characters`; 
            updateSaveButtonState(); 
        });
        memoNameInput.addEventListener('input', updateSaveButtonState);
        
        memoDateInput.addEventListener('input', () => {
            updateMemoWeekBasedOnDateInput(); 
            updateSaveButtonState();
        }); 
        memoWeekInput.addEventListener('input', updateSaveButtonState); 

        saveButton.addEventListener('click', () => { 
            const message = messageInput.value.trim(); 
            const memoNameBase = memoNameInput.value.trim(); 
            const memoDateString = memoDateInput.value.trim(); 
            const memoWeekString = memoWeekInput.value.trim(); 
            const importance = selectedImportance; 
            let currentMemos = pages[currentPage] || []; 
            if (!Array.isArray(currentMemos)) currentMemos = [];


            const parsedDateForWeekday = parseDateString(memoDateString);
            const weekdayAbbr = parsedDateForWeekday ? getWeekdayAbbreviation(parsedDateForWeekday) : '';

            const fullMemoName = `${memoNameBase} - ${memoDateString} ${weekdayAbbr} | ${memoWeekString}`;

            if (memoNameBase && memoDateString && memoWeekString && message && importance && currentMemos.length < maxMemos) { 
                const memoObj = { 
                    name: fullMemoName, 
                    content: messageInput.value, 
                    importance, 
                    timestamp: Date.now(), 
                    bgColorClass: getRandomMemoBgClass() 
                }; 
                if (!Array.isArray(pages[currentPage])) {
                     pages[currentPage] = [];
                }
                pages[currentPage].unshift(memoObj); 
                saveAllData(); 
                
                messageInput.value = ''; 
                memoNameInput.value = ''; 
                charCount.textContent = `0 characters`; 
                selectedImportance = null;
                importanceButtonsContainer.querySelectorAll('.importance-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                updateDateAndWeekInputs(); 
                // updateUI will be called automatically by the firebase 'on' listener
                showNotification('Memo saved! ✨'); 
            } else if (currentMemos.length >= maxMemos) { 
                showNotification('Maximum memo limit reached for this page.', 'error'); 
            } else if (!memoNameBase) { 
                showNotification('Memo name cannot be empty.', 'error'); memoNameInput.focus(); 
            } else if (!memoDateString) { 
                showNotification('Memo date cannot be empty.', 'error'); memoDateInput.focus(); 
            } else if (!memoWeekString) { 
                showNotification('Memo week cannot be empty.', 'error'); memoWeekInput.focus(); 
            } else if (!message) { 
                showNotification('Message content cannot be empty.', 'error'); messageInput.focus(); 
            } else if (!importance) { 
                showNotification('Please select an importance level.', 'error'); 
            } 
        });
        addPageButton.addEventListener('click', () => { 
            const newPageName = newPageNameInput.value.trim(); 
            if (newPageName) { 
                addPage(newPageName); 
                newPageNameInput.value = ''; 
            } else { 
                showNotification('Page name cannot be empty.', 'error'); 
            } 
        });
        newPageNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPageButton.click(); });

        // --- Page Drag and Drop Handlers ---
        let pageDropIndicator = null; 
        function handlePageDragStart(event) {
            draggedPageName = event.target.dataset.pageName;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedPageName);
        }
        function handlePageDragOver(event) {
            event.preventDefault();
            const targetPageButton = event.target.closest('#pagesContainer .action-button');

            if (draggedOverPageTargetElement && draggedOverPageTargetElement !== targetPageButton) {
                draggedOverPageTargetElement.classList.remove('drag-target-glow');
                draggedOverPageTargetElement = null;
            }

            if (targetPageButton && targetPageButton.dataset.pageName !== draggedPageName) {
                targetPageButton.classList.add('drag-target-glow');
                draggedOverPageTargetElement = targetPageButton;
            } else if (!targetPageButton && event.currentTarget === pagesContainer) { 
                if (draggedOverPageTargetElement) {
                    draggedOverPageTargetElement.classList.remove('drag-target-glow');
                    draggedOverPageTargetElement = null;
                }
            }
        }
        function handlePageDragLeave(event) {
            if (draggedOverPageTargetElement) {
                draggedOverPageTargetElement.classList.remove('drag-target-glow');
                draggedOverPageTargetElement = null;
            }
        }
        function handlePageDrop(event) {
            event.preventDefault();
            
            if (draggedOverPageTargetElement) {
                draggedOverPageTargetElement.classList.remove('drag-target-glow');
                draggedOverPageTargetElement = null;
            }

            if (!draggedPageName) { 
                const draggingElem = pagesContainer.querySelector(`.action-button[data-page-name="${draggedPageName}"]`);
                if(draggingElem) draggingElem.classList.remove('dragging');
                draggedPageName = null;
                return;
            }

            const oldIndex = pageOrder.indexOf(draggedPageName);
            pageOrder.splice(oldIndex, 1); 

            const allPageButtons = Array.from(pagesContainer.querySelectorAll('.action-button'));
            let newIndex = allPageButtons.length; 
            const targetPageButton = event.target.closest('.action-button');

            if (targetPageButton && targetPageButton.dataset.pageName !== draggedPageName) {
                const targetIndex = allPageButtons.indexOf(targetPageButton);
                const rect = targetPageButton.getBoundingClientRect();
                const isAfter = event.clientX > rect.left + rect.width / 2;
                newIndex = targetIndex;
                if (isAfter) {
                    newIndex = targetIndex + 1;
                }
                if (oldIndex < newIndex) {
                    newIndex--; 
                }
            }
            
            pageOrder.splice(newIndex, 0, draggedPageName); 

            saveAllData();
            // renderPages(); // Not needed, handled by Firebase listener

            const finalDraggingElem = pagesContainer.querySelector(`.action-button[data-page-name="${draggedPageName}"]`);
            if(finalDraggingElem) finalDraggingElem.classList.remove('dragging');
            draggedPageName = null;
        }
        function handlePageDragEnd(event) {
            const elem = event.target.closest('.action-button');
            if(elem) elem.classList.remove('dragging');
            if(draggedOverPageTargetElement) draggedOverPageTargetElement.classList.remove('drag-target-glow');
            draggedPageName = null;
            draggedOverPageTargetElement = null;
        }

        // --- Global Search Functions ---
        function performGlobalSearch() { 
            const allMemos = [];
            pageOrder.forEach(pageName => {
                if (pages[pageName] && Array.isArray(pages[pageName])) {
                    pages[pageName].forEach((memo, index) => {
                        allMemos.push({ ...memo, pageName, originalIndex: index, memoId: `${pageName}-${index}` });
                    });
                }
            });
            displaySearchResultsModal(allMemos, ''); 
        }
        function displaySearchResultsModal(allMemos, initialSearchTerm) {
            const existingModal = document.getElementById('searchResultsModal'); 
            if(existingModal) existingModal.remove(); 
            
            const overlay = document.createElement('div'); 
            overlay.id = 'searchResultsModal'; 
            overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-[100]';
            const modal = document.createElement('div'); 
            modal.className = 'modal-content search-results-modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-6 sm:p-8 shadow-2xl';
            
            modal.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-800">Search Memos</h3>
                        <button id="closeSearchModalButton" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="modalSearchInput" class="input-field w-full p-3 rounded-xl focus:outline-none text-sm" placeholder="Search all memos..." value="${initialSearchTerm}">
                    </div>
                    <div class="search-modal-body scrollbar-custom pr-2">
                        </div>
                </div>
            `;
            overlay.appendChild(modal); 
            document.body.appendChild(overlay); 
            document.body.style.overflow = 'hidden'; 

            const modalSearchInput = modal.querySelector('#modalSearchInput');
            const searchResultsContainer = modal.querySelector('.search-modal-body');

            const renderFilteredResults = (searchTerm) => {
                const lowerCaseSearchTerm = searchTerm.trim().toLowerCase();
                const keywords = lowerCaseSearchTerm.split(/\s+/).filter(word => word.length > 0); 

                const filteredResults = allMemos.filter(memo => {
                    const importanceLabel = getImportanceLabel(memo.importance).toLowerCase();
                    const searchableText = `${memo.name.toLowerCase()} ${memo.content.toLowerCase()} ${importanceLabel}`;
                    
                    return keywords.every(keyword => searchableText.includes(keyword));
                });

                let resultsHTML = '';
                if (filteredResults.length > 0) {
                    filteredResults.forEach(memo => {
                        const date = new Date(memo.timestamp); 
                        const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`; 
                        const formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); 
                        const displayTimestamp = `${formattedDate} ${formattedTime}`;
                        
                        let displayName = memo.name;
                        let displayContent = memo.content;
                        let displayImportanceLabel = getImportanceLabel(memo.importance);

                        keywords.forEach(keyword => {
                            const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                            displayName = displayName.replace(regex, '<mark class="bg-yellow-200 rounded">$1</mark>');
                            displayContent = displayContent.replace(regex, '<mark class="bg-yellow-200 rounded">$1</mark>');
                            displayImportanceLabel = displayImportanceLabel.replace(regex, '<mark class="bg-yellow-200 rounded">$1</mark>');
                        });
                        
                        resultsHTML += `
                            <div class="search-result-item ${getImportanceBorderClass(memo.importance)} border-l-4 pl-3" data-target-page="${memo.pageName}" data-memo-id="${memo.memoId}">
                                <h4 class="font-semibold text-lg text-gray-800 mb-1">${displayName}</h4>
                                <p class="text-xs text-gray-500 mb-1">On page: ${memo.pageName}</p>
                                <div class="flex items-center gap-1 text-sm text-gray-700 mb-2">
                                    <div class="importance-light ${getImportanceLightClass(memo.importance)}"></div>
                                    <span>${displayImportanceLabel}</span>
                                </div>
                                <div class="search-result-content text-sm text-gray-700 mb-2 whitespace-pre-wrap scrollbar-custom">${displayContent}</div>
                                <p class="text-xs text-gray-500 text-right">${displayTimestamp}</p>
                            </div>`;
                    });
                } else { 
                    resultsHTML = '<p class="text-gray-600 text-center py-4">No memos found matching your search.</p>'; 
                }
                searchResultsContainer.innerHTML = resultsHTML;

                searchResultsContainer.querySelectorAll('.search-result-content').forEach(contentDiv => {
                    const firstHighlight = contentDiv.querySelector('mark');
                    if (firstHighlight) {
                        firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });


                searchResultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const targetPage = item.dataset.targetPage;
                        const targetMemoId = item.dataset.memoId;
                        switchPage(targetPage); 
                        setTimeout(() => { 
                            const memoElement = document.querySelector(`.memo-note[data-memo-id="${targetMemoId}"]`);
                            if (memoElement) {
                                memoElement.classList.add('memo-shake-effect');
                                setTimeout(() => {
                                    memoElement.classList.remove('memo-shake-effect');
                                    memoElement.classList.add('memo-highlight-effect');
                                    const firstHighlightInMemo = memoElement.querySelector('mark');
                                    if (firstHighlightInMemo) {
                                        firstHighlightInMemo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    } else {
                                        memoElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }
                                    setTimeout(() => { 
                                        memoElement.classList.remove('memo-highlight-effect');
                                    }, 5000); 
                                }, 500); 
                            }
                        }, 100); 
                        document.body.style.overflow = ''; 
                        overlay.remove(); 
                    });
                });
            };

            renderFilteredResults(initialSearchTerm);

            modalSearchInput.addEventListener('input', (e) => {
                renderFilteredResults(e.target.value);
            });
            modalSearchInput.focus(); 

            modal.querySelector('#closeSearchModalButton').addEventListener('click', () => { 
                document.body.style.overflow = ''; 
                overlay.remove(); 
            });
        }
        
        globalSearchButton.addEventListener('click', () => {
            currentFilter = 'all';
            importanceFilterContainer.querySelectorAll('.filter-importance-button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.filter === 'all');
            });
            updateMemoList(); 
            if (filterNotificationArea) {
                filterNotificationArea.classList.add('hidden');
            }
            performGlobalSearch(); 
        });

        // --- Export to Excel Functionality ---
        function exportToExcel() {
            let currentMemos = pages[currentPage] || [];
            if (!Array.isArray(currentMemos)) currentMemos = Object.values(currentMemos);

            if (currentMemos.length === 0) {
                showNotification('No memos on this page to export.', 'info');
                return;
            }

            const headers = ["Name", "Content", "Importance", "Timestamp"];
            let csvContent = headers.map(header => `"${header.replace(/"/g, '""')}"`).join(',') + '\n';

            currentMemos.forEach(memo => {
                if (!memo) return;
                const name = `"${memo.name.replace(/"/g, '""')}"`;
                const content = `"${memo.content.replace(/"/g, '""')}"`; 
                const importance = `"${getImportanceLabel(memo.importance).replace(/"/g, '""')}"`;
                const date = new Date(memo.timestamp);
                const formattedTimestamp = `"${date.toLocaleString().replace(/"/g, '""')}"`; 

                csvContent += [name, content, importance, formattedTimestamp].join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `${currentPage}_memos.csv`);
            link.style.visibility = 'hidden'; 
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            URL.revokeObjectURL(url); 

            showNotification(`Exported ${currentMemos.length} memos from "${currentPage}"!`);
        }
        exportButton.addEventListener('click', exportToExcel);

        // --- UI Update and Initialization ---

        function updateUI() { 
            const user = auth.currentUser;
            if (!user) {
                memoDisplayArea.innerHTML = '';
                pagesContainer.innerHTML = '';
                currentMemoPageTitle.textContent = 'Memos';
                messageCount.textContent = `0/53 memos`;
                return;
            }

            if (!pages[currentPage] && pageOrder && pageOrder.length > 0) { 
                currentPage = pageOrder[0]; 
            } else if (!pages[currentPage]) { 
                currentPage = 'default'; 
                if(!pageOrder.includes('default')) pageOrder.push('default'); 
                if(!pages.default) pages.default = []; 
            } 
            
            renderPages(); 
            updateMemoList(); 
            const pageTitle = currentPage ? currentPage.charAt(0).toUpperCase() + currentPage.slice(1) : 'Memos'; 
            currentMemoPageTitle.textContent = `${pageTitle} Memos`; 
            updateSaveButtonState(); 
            
            selectedImportance = null;
            importanceButtonsContainer.querySelectorAll('.importance-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            importanceFilterContainer.querySelectorAll('.filter-importance-button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.filter === currentFilter);
            });

            if (filterNotificationArea) {
                if (currentFilter !== 'all') {
                    filterNotificationArea.textContent = 'Drag-and-drop reordering is disabled while a filter is active.';
                    filterNotificationArea.classList.remove('hidden');
                } else {
                    filterNotificationArea.classList.add('hidden');
                }
            }
        }
        
        importanceFilterContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.filter-importance-button');
            if (clickedButton) {
                importanceFilterContainer.querySelectorAll('.filter-importance-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                clickedButton.classList.add('selected');
                currentFilter = clickedButton.dataset.filter;
                updateMemoList(); 

                if (filterNotificationArea) {
                    if (currentFilter !== 'all') {
                        filterNotificationArea.textContent = 'Drag-and-drop reordering is disabled while a filter is active.';
                        filterNotificationArea.classList.remove('hidden');
                    } else {
                        filterNotificationArea.classList.add('hidden');
                    }
                }
            }
        });

        // Initialize Flatpickr only once
        if(!flatpickrInstance) {
            flatpickrInstance = flatpickr(memoDateInput, {
                dateFormat: "d/m/Y",      
                altInput: true,          
                altFormat: "d/m/Y",      
                allowInput: true,        
                clickOpens: false,       
                defaultDate: "today",
                onChange: function(selectedDates, dateStr, instance) {
                    const event = new Event('input', { bubbles: true });
                    instance.input.dispatchEvent(event);
                }
            });

            if (flatpickrInstance && flatpickrInstance.altInput) {
                flatpickrInstance.altInput.addEventListener('change', () => {
                    const event = new Event('input', { bubbles: true });
                    memoDateInput.dispatchEvent(event); 
                });
            }

            memoDateIcon.addEventListener('click', () => {
                if (flatpickrInstance) {
                    flatpickrInstance.open();
                }
            });
        }
        
        // --- Large Message Input Modal Logic ---
        openLargeMessageInputModalButton.addEventListener('click', () => {
            largeMessageInputTextArea.value = messageInput.value; // Populate with current content
            largeMessageInputModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            largeMessageInputTextArea.focus();
        });

        closeLargeMessageInputModalButton.addEventListener('click', () => {
            // This button now triggers save functionality before closing
            messageInput.value = largeMessageInputTextArea.value; // Transfer content back
            charCount.textContent = `${messageInput.value.length} characters`; // Update character count
            updateSaveButtonState(); // Update save button state
            largeMessageInputModal.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        });

        // Removed the individual save and cancel buttons as per request.
        // The close button now handles saving.

    </script>
</body>
</html>
